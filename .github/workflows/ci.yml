name: CI (tests only)

on:
  pull_request:
    branches: ["main"]
  push:
    branches:
      - "feat/**"
      - "feature/**"
      - "bugfix/**"
      - "hotfix/**"
    paths:
      - "services/**"

permissions:
  contents: read
  pull-requests: read

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.set.outputs.changed }}
      auth: ${{ steps.filter.outputs.auth }}
      user: ${{ steps.filter.outputs.user }}
      chat: ${{ steps.filter.outputs.chat }}
      ws: ${{ steps.filter.outputs.ws }}
      notif: ${{ steps.filter.outputs.notif }}
      media: ${{ steps.filter.outputs.media }}
      web: ${{ steps.filter.outputs.web }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            auth:  ["services/auth-service/**"]
            user:  ["services/user-service/**"]
            chat:  ["services/chat-service/**"]
            ws:    ["services/ws-manager/**"]
            notif: ["services/notification-service/**"]
            media: ["services/media-service/**"]
            web:   ["services/web-frontend/**"]

      - id: set
        run: |
          if [[ "${{ steps.filter.outputs.auth }}" == "true" || \
                "${{ steps.filter.outputs.user }}" == "true" || \
                "${{ steps.filter.outputs.chat }}" == "true" || \
                "${{ steps.filter.outputs.ws }}" == "true" || \
                "${{ steps.filter.outputs.notif }}" == "true" || \
                "${{ steps.filter.outputs.media }}" == "true" || \
                "${{ steps.filter.outputs.web }}" == "true" ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

  test-spring:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.changed == 'true' && (needs.detect-changes.outputs.auth == 'true' || needs.detect-changes.outputs.user == 'true' || needs.detect-changes.outputs.chat == 'true' || needs.detect-changes.outputs.ws == 'true' || needs.detect-changes.outputs.notif == 'true' || needs.detect-changes.outputs.media == 'true')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Run Spring tests (only changed services)
        shell: bash
        run: |
          set -e
          run_maven_tests () {
            svc="$1"
            if [ -f "services/$svc/mvnw" ]; then
              chmod +x "services/$svc/mvnw"
              (cd "services/$svc" && ./mvnw -q test)
            elif [ -f "services/$svc/pom.xml" ]; then
              (cd "services/$svc" && mvn -q test)
            fi
          }

          if [[ "${{ needs.detect-changes.outputs.auth }}" == "true" ]]; then run_maven_tests "auth-service"; fi
          if [[ "${{ needs.detect-changes.outputs.user }}" == "true" ]]; then run_maven_tests "user-service"; fi
          if [[ "${{ needs.detect-changes.outputs.chat }}" == "true" ]]; then run_maven_tests "chat-service"; fi
          if [[ "${{ needs.detect-changes.outputs.ws }}" == "true" ]]; then run_maven_tests "ws-manager"; fi
          if [[ "${{ needs.detect-changes.outputs.notif }}" == "true" ]]; then run_maven_tests "notification-service"; fi
          if [[ "${{ needs.detect-changes.outputs.media }}" == "true" ]]; then run_maven_tests "media-service"; fi

  test-react:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.web == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: services/web-frontend/package-lock.json

      - name: Install deps
        working-directory: services/web-frontend
        run: npm ci

      - name: Run React tests
        working-directory: services/web-frontend
        run: |
          if node -e "const s=require('./package.json').scripts||{}; process.exit(s.test?0:1)"; then
            npm test -- --runInBand
          else
            echo "No test script defined for web-frontend, skipping tests."
          fi
