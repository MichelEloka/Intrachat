name: Promote image (staging / prod)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options: [staging, prod]
      tag:
        description: "Image tag to promote (ex: sha-a1b2c3d)"
        required: true

permissions:
  contents: write
  packages: read

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Compute owner
        run: |
          echo "OWNER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Login to GHCR (for tag existence check)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify images exist in registry
        run: |
          TAG="${{ inputs.tag }}"
          docker manifest inspect ghcr.io/${OWNER}/intrachat-auth-service:${TAG} >/dev/null
          docker manifest inspect ghcr.io/${OWNER}/intrachat-web-frontend:${TAG} >/dev/null
          echo " Images exist: ${TAG}"

      - name: Promote tag
        run: |
          ENV=${{ inputs.environment }}
          TAG=${{ inputs.tag }}

          sed -i "s/newTag:.*/newTag: $TAG/" gitops/env/$ENV/apps/auth-service/kustomization.yaml
          sed -i "s/newTag:.*/newTag: $TAG/" gitops/env/$ENV/apps/web-frontend/kustomization.yaml

      - name: Commit promotion
        run: |
          ENV=${{ inputs.environment }}
          TAG=${{ inputs.tag }}

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add gitops/env/$ENV

          if git diff --staged --quiet; then
            echo "No changes to commit (already promoted)."
            exit 0
          fi

          git commit -m "chore($ENV): promote $TAG"
          git push
