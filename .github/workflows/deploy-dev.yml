name: Deploy DEV (main) - test, build once, update GitOps

on:
  push:
    branches: ["main"]
    paths:
      - "services/**"

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: intrachat

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      auth: ${{ steps.filter.outputs.auth }}
      user: ${{ steps.filter.outputs.user }}
      chat: ${{ steps.filter.outputs.chat }}
      ws: ${{ steps.filter.outputs.ws }}
      notif: ${{ steps.filter.outputs.notif }}
      media: ${{ steps.filter.outputs.media }}
      web: ${{ steps.filter.outputs.web }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            auth:  ["services/auth-service/**"]
            user:  ["services/user-service/**"]
            chat:  ["services/chat-service/**"]
            ws:    ["services/ws-manager/**"]
            notif: ["services/notification-service/**"]
            media: ["services/media-service/**"]
            web:   ["services/web-frontend/**"]

  tests:
    runs-on: ubuntu-latest
    needs: detect-changes
    steps:
      - uses: actions/checkout@v4

      # Java tests (only if any backend changed)
      - uses: actions/setup-java@v4
        if: needs.detect-changes.outputs.auth == 'true' || needs.detect-changes.outputs.user == 'true' || needs.detect-changes.outputs.chat == 'true' || needs.detect-changes.outputs.ws == 'true' || needs.detect-changes.outputs.notif == 'true' || needs.detect-changes.outputs.media == 'true'
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Spring tests (changed services only)
        if: needs.detect-changes.outputs.auth == 'true' || needs.detect-changes.outputs.user == 'true' || needs.detect-changes.outputs.chat == 'true' || needs.detect-changes.outputs.ws == 'true' || needs.detect-changes.outputs.notif == 'true' || needs.detect-changes.outputs.media == 'true'
        shell: bash
        run: |
          set -e
          run_maven_tests () {
            svc="$1"
            if [ -f "services/$svc/mvnw" ]; then
              chmod +x "services/$svc/mvnw"
              (cd "services/$svc" && ./mvnw -q test)
            elif [ -f "services/$svc/pom.xml" ]; then
              (cd "services/$svc" && mvn -q test)
            fi
          }

          if [[ "${{ needs.detect-changes.outputs.auth }}" == "true" ]]; then run_maven_tests "auth-service"; fi
          if [[ "${{ needs.detect-changes.outputs.user }}" == "true" ]]; then run_maven_tests "user-service"; fi
          if [[ "${{ needs.detect-changes.outputs.chat }}" == "true" ]]; then run_maven_tests "chat-service"; fi
          if [[ "${{ needs.detect-changes.outputs.ws }}" == "true" ]]; then run_maven_tests "ws-manager"; fi
          if [[ "${{ needs.detect-changes.outputs.notif }}" == "true" ]]; then run_maven_tests "notification-service"; fi
          if [[ "${{ needs.detect-changes.outputs.media }}" == "true" ]]; then run_maven_tests "media-service"; fi

      # React tests (only if web changed)
      - uses: actions/setup-node@v4
        if: needs.detect-changes.outputs.web == 'true'
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: services/web-frontend/package-lock.json

      - name: React tests
        if: needs.detect-changes.outputs.web == 'true'
        working-directory: services/web-frontend
        run: |
          npm ci
          if node -e "const s=require('./package.json').scripts||{}; process.exit(s.test?0:1)"; then
            npm test -- --runInBand
          else
            echo "No test script defined for web-frontend, skipping tests."
          fi

  build-push-and-update-gitops:
    runs-on: ubuntu-latest
    needs: [detect-changes, tests]
    steps:
      - uses: actions/checkout@v4

      - name: Compute immutable tag + owner
        run: |
          echo "TAG=sha-${GITHUB_SHA::7}" >> $GITHUB_ENV
          echo "OWNER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Build & push only changed
      - name: Build & push auth-service
        if: needs.detect-changes.outputs.auth == 'true'
        uses: docker/build-push-action@v6
        with:
          context: services/auth-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.OWNER }}/intrachat-auth-service:${{ env.TAG }}
            ${{ env.REGISTRY }}/${{ env.OWNER }}/intrachat-auth-service:latest

      - name: Build & push user-service
        if: needs.detect-changes.outputs.user == 'true'
        uses: docker/build-push-action@v6
        with:
          context: services/user-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.OWNER }}/intrachat-user-service:${{ env.TAG }}
            ${{ env.REGISTRY }}/${{ env.OWNER }}/intrachat-user-service:latest

      - name: Build & push chat-service
        if: needs.detect-changes.outputs.chat == 'true'
        uses: docker/build-push-action@v6
        with:
          context: services/chat-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.OWNER }}/intrachat-chat-service:${{ env.TAG }}
            ${{ env.REGISTRY }}/${{ env.OWNER }}/intrachat-chat-service:latest

      - name: Build & push ws-manager
        if: needs.detect-changes.outputs.ws == 'true'
        uses: docker/build-push-action@v6
        with:
          context: services/ws-manager
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.OWNER }}/intrachat-ws-manager:${{ env.TAG }}
            ${{ env.REGISTRY }}/${{ env.OWNER }}/intrachat-ws-manager:latest

      - name: Build & push notification-service
        if: needs.detect-changes.outputs.notif == 'true'
        uses: docker/build-push-action@v6
        with:
          context: services/notification-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.OWNER }}/intrachat-notification-service:${{ env.TAG }}
            ${{ env.REGISTRY }}/${{ env.OWNER }}/intrachat-notification-service:latest

      - name: Build & push media-service
        if: needs.detect-changes.outputs.media == 'true'
        uses: docker/build-push-action@v6
        with:
          context: services/media-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.OWNER }}/intrachat-media-service:${{ env.TAG }}
            ${{ env.REGISTRY }}/${{ env.OWNER }}/intrachat-media-service:latest

      - name: Build & push web-frontend
        if: needs.detect-changes.outputs.web == 'true'
        uses: docker/build-push-action@v6
        with:
          context: services/web-frontend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.OWNER }}/intrachat-web-frontend:${{ env.TAG }}
            ${{ env.REGISTRY }}/${{ env.OWNER }}/intrachat-web-frontend:latest
          build-args: |
            VITE_MODE=dev

      # Update GitOps only for changed services
      - name: Update GitOps DEV tags (only changed)
        shell: bash
        run: |
          set -e
          update_newtag () {
            file="$1"
            if [ -f "$file" ]; then
              python3 -c 'import sys, pathlib, re; p = pathlib.Path(sys.argv[1]); tag = sys.argv[2]; s = p.read_text(); s = re.sub(r"(newTag:\\s*).+", r"\\1" + tag, s); p.write_text(s); print("updated", p)' "$file" "$TAG"
            fi
          }

          if [[ "${{ needs.detect-changes.outputs.auth }}" == "true" ]]; then update_newtag "gitops/env/dev/apps/auth-service/overlay/kustomization.yaml"; fi
          if [[ "${{ needs.detect-changes.outputs.user }}" == "true" ]]; then update_newtag "gitops/env/dev/apps/user-service/overlay/kustomization.yaml"; fi
          if [[ "${{ needs.detect-changes.outputs.chat }}" == "true" ]]; then update_newtag "gitops/env/dev/apps/chat-service/overlay/kustomization.yaml"; fi
          if [[ "${{ needs.detect-changes.outputs.ws }}" == "true" ]]; then update_newtag "gitops/env/dev/apps/ws-manager/overlay/kustomization.yaml"; fi
          if [[ "${{ needs.detect-changes.outputs.notif }}" == "true" ]]; then update_newtag "gitops/env/dev/apps/notification-service/overlay/kustomization.yaml"; fi
          if [[ "${{ needs.detect-changes.outputs.media }}" == "true" ]]; then update_newtag "gitops/env/dev/apps/media-service/overlay/kustomization.yaml"; fi
          if [[ "${{ needs.detect-changes.outputs.web }}" == "true" ]]; then update_newtag "gitops/env/dev/apps/web-frontend/overlay/kustomization.yaml"; fi

      - name: Commit GitOps DEV
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add gitops/env/dev || true
          if git diff --staged --quiet; then
            echo "No GitOps changes to commit."
            exit 0
          fi
          git commit -m "chore(dev): deploy $TAG"
          git push
